"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.for-each"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.some"),require("core-js/modules/es.function.bind"),require("core-js/modules/es.map"),require("core-js/modules/es.object.assign"),require("core-js/modules/es.object.keys"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.object.values"),require("core-js/modules/es.promise"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.string.iterator"),require("core-js/modules/es.string.search"),require("core-js/modules/es.string.split"),require("core-js/modules/esnext.map.delete-all"),require("core-js/modules/esnext.map.every"),require("core-js/modules/esnext.map.filter"),require("core-js/modules/esnext.map.find"),require("core-js/modules/esnext.map.find-key"),require("core-js/modules/esnext.map.includes"),require("core-js/modules/esnext.map.key-of"),require("core-js/modules/esnext.map.map-keys"),require("core-js/modules/esnext.map.map-values"),require("core-js/modules/esnext.map.merge"),require("core-js/modules/esnext.map.reduce"),require("core-js/modules/esnext.map.some"),require("core-js/modules/esnext.map.update"),require("core-js/modules/web.dom-collections.for-each"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_call=_interopRequireDefault(require("./call")),_all=_interopRequireDefault(require("./all")),_race=_interopRequireDefault(require("./race")),_select=_interopRequireDefault(require("./select")),_put=_interopRequireDefault(require("./put")),_history=_interopRequireDefault(require("./history")),_util=require("../../util"),_qs=require("../../util/qs");function ownKeys(r,e){var t,s=Object.keys(r);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(r),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),s.push.apply(s,t)),s}function _objectSpread(r){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(t),!0).forEach(function(e){(0,_defineProperty2.default)(r,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(t,e))})}return r}var Saga=function(){function e(){(0,_classCallCheck2.default)(this,e),this.models=new Map,this.history=_history.default}return(0,_createClass2.default)(e,[{key:"setStore",value:function(e){this.store=e,this.store.state.loading||(this.store.state.loading={global:!1})}},{key:"setRouter",value:function(e){var t=this;this.router=e;var s=t.router.history.listen.bind(t.router.history);this.router.history.listen=function(r){r(_objectSpread(_objectSpread({},{pathname:window.location.pathname,search:window.location.search,query:(0,_qs.parse)()}),{},{state:_objectSpread({},t.store.state)})),s(function(e){r(_objectSpread(_objectSpread({},e||{}),{},{state:_objectSpread({},t.store.state)}))})},t.router.history=Array.from(t.models.values()).forEach(function(e){"subscriptions"in e&&(0,_util.isObject)(e.subscriptions)&&"setup"in e.subscriptions&&(0,_util.isFunction)(e.subscriptions.setup)&&e.subscriptions.setup({history:t.router.history,dispatch:t.store.dispatch.bind(t.store)})})}},{key:"model",value:function(e){return!!e&&(this.clearUnSubscriptions(e),this.models.set(e.namespace,e),this.init(e),!0)}},{key:"unModel",value:function(e){var r=this.models.get(e);r&&(this.clearUnSubscriptions(r),this.models.delete(e),delete this.store.state[e])}},{key:"hasModel",value:function(e){return!!this.models.get(e)}},{key:"replaceModel",value:function(e){return this.model(e)}},{key:"getModel",value:function(e){return this.models.get(e)}},{key:"run",value:function(e){var t=this,s=e.g,o=e.params,i=e.model;return new Promise(function(r,e){var a=s(o,{call:_call.default,all:_all.default,race:_race.default,select:(0,_select.default)(t),put:_put.default.call(t,{store:t.store,params:o,model:i,run:t.run.bind(t)})});(function i(u){return new Promise(function(r,t){function s(e){i(e).then(function(e){r(e)}).catch(function(e){a.throw(e),t(e)})}var e=a.next(u),o=e.value;e.done?r(o):o instanceof Promise?o.then(function(e){s(e)}).catch(function(e){a.throw(e),t(e)}):s(o)})})().then(function(e){r(e)}).catch(function(){e()})})}},{key:"clearUnSubscriptions",value:function(e){e=e.unsubscriptions,e=void 0===e?{}:e;e&&Object.values(e).forEach(function(e){e()})}},{key:"init",value:function(e){var r=e.namespace,t=e.state,s={};Object.keys(e.effects).forEach(function(e){s["".concat(r,"/").concat(e)]=!1}),Object.assign(this.store.state.loading,s),this.store.state[r]=[r]in this.store.state?this.store.state[r]:t}},{key:"isGlobalLoading",value:function(){var t=this.store.state.loading;return Array.from(this.models).some(function(e){var e=(0,_slicedToArray2.default)(e,2),r=e[0],e=e[1];return Array.from(Object.keys(e.effects)).some(function(e){e="".concat(r,"/").concat(e);return!0===t[e]})})}},{key:"before",value:function(e){var o=this,i=e.state,u=e.action;return new Promise(function(e){var r=u.type,t=r.split("/"),s=(0,_slicedToArray2.default)(t,2),t=s[0],s=s[1],t=o.models.get(t);t&&t.effects[s]&&(i.loading[r]=!0,i.loading.global=!0),e(i)})}},{key:"after",value:function(e){var a=this,n=e.state,l=e.action;return new Promise(function(r){var t=l.type,e=(l.ins,l.success,(0,_objectWithoutProperties2.default)(l,["type","ins","success"])),s=t.split("/"),o=(0,_slicedToArray2.default)(s,2),i=o[0],s=o[1],u=a.models.get(i);u?(o=u.effects[s])?a.run({g:o,state:n,params:e,model:u}).then(function(e){n.loading[t]=!1,n[i]=u.state,n.loading.global=a.isGlobalLoading(),r(e)}):u.reducers[s]&&(u.state=u.reducers[s](n[i],{payload:e}),n[i]=u.state,r(n)):r(n)})}}]),e}(),_default=function(){return new Saga};exports.default=_default;
//# sourceMappingURL=index.js.map
