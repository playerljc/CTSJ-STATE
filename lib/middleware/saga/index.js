"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_call=_interopRequireDefault(require("./call")),_all=_interopRequireDefault(require("./all")),_race=_interopRequireDefault(require("./race")),_select=_interopRequireDefault(require("./select")),_put=_interopRequireDefault(require("./put")),_history=_interopRequireDefault(require("./history")),Saga=function(){function e(){(0,_classCallCheck2.default)(this,e),this.models=new Map,this.history=_history.default}return(0,_createClass2.default)(e,[{key:"setStore",value:function(e){this.store=e,this.store.state.loading||(this.store.state.loading={global:!1})}},{key:"model",value:function(e){return!!e&&(this.clearUnSubscriptions(e),this.models.set(e.namespace,e),this.init(e),!0)}},{key:"unmodel",value:function(e){var t=this.models.get(e);t&&(this.clearUnSubscriptions(t),this.models.delete(e),delete this.store.state[e])}},{key:"hasModel",value:function(e){return!!this.models.get(e)}},{key:"replaceModel",value:function(e){return this.model(e)}},{key:"getModel",value:function(e){return this.models.get(e)}},{key:"run",value:function(e){var r=this,i=e.g,a=e.state,s=e.params,n=e.model;return new Promise(function(e,t){var o=i(s,{call:_call.default,all:_all.default,race:_race.default,select:(0,_select.default)(a),put:(0,_put.default)({store:r.store,params:s,model:n,run:r.run.bind(r)})});(function s(n){return new Promise(function(t,r){function i(e){s(e).then(function(){t()}).catch(function(e){o.throw(e),r(e)})}var e=o.next(n),a=e.value;e.done?t():a instanceof Promise?a.then(function(e){i(e)}).catch(function(e){o.throw(e),r(e)}):i(a)})})().then(function(){e()}).catch(function(){t()})})}},{key:"initSubscriptions",value:function(e){var t=this,r=e.subscriptions,i=void 0===r?{}:r;i&&Object.values(i).forEach(function(e){e({dispatch:t.store.dispatch,history:t.history})})}},{key:"clearUnSubscriptions",value:function(e){var t=e.unsubscriptions,r=void 0===t?{}:t;r&&Object.values(r).forEach(function(e){e()})}},{key:"init",value:function(e){var t=e.namespace,r=e.state,i={};Object.keys(e.effects).forEach(function(e){i["".concat(t,"/").concat(e)]=!1}),Object.assign(this.store.state.loading,i),this.store.state[t]=[t]in this.store.state?this.store.state[t]:r,this.initSubscriptions(e)}},{key:"isGlobalLoading",value:function(){var a=this.store.state.loading;return Array.from(this.models).some(function(e){var t=(0,_slicedToArray2.default)(e,2),r=t[0],i=t[1];return Array.from(Object.keys(i.effects)).some(function(e){var t="".concat(r,"/").concat(e);return!0===a[t]})})}},{key:"before",value:function(e){var o=this,u=e.state,l=e.action;return new Promise(function(e){var t=l.type,r=t.split("/"),i=(0,_slicedToArray2.default)(r,2),a=i[0],s=i[1],n=o.models.get(a);n&&n.effects[s]&&(u.loading[t]=!0,u.loading.global=!0),e(u)})}},{key:"after",value:function(e){var l=this,c=e.state,f=e.action;return new Promise(function(e){var t,r=f.type,i=(f.ins,f.success,(0,_objectWithoutProperties2.default)(f,["type","ins","success"])),a=r.split("/"),s=(0,_slicedToArray2.default)(a,2),n=s[0],o=s[1],u=l.models.get(n);u?(t=u.effects[o])?l.run({g:t,state:c,params:i,model:u}).then(function(){c[n]=u.state,c.loading[r]=!1,c.loading.global=l.isGlobalLoading(),e(c)}):u.reducers[o]&&(u.state=u.reducers[o](c[n],{payload:i}),c[n]=u.state,e(c)):e(c)})}}]),e}(),_default=function(){return new Saga};exports.default=_default;
//# sourceMappingURL=index.js.map
