"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_call=_interopRequireDefault(require("./call")),_all=_interopRequireDefault(require("./all")),_race=_interopRequireDefault(require("./race")),_select=_interopRequireDefault(require("./select")),_put=_interopRequireDefault(require("./put")),_history=_interopRequireDefault(require("./history")),_immutable=_interopRequireDefault(require("../../util/immutable")),Saga=function(){function e(){(0,_classCallCheck2.default)(this,e),this.models=new Map,this.history=_history.default}return(0,_createClass2.default)(e,[{key:"model",value:function(e){return!!e&&(this.clearUnSubscriptions(e),this.models.set(e.namespace,e),this.init(e),!0)}},{key:"unmodel",value:function(e){var t=this.models.get(e);t&&(this.clearUnSubscriptions(t),this.models.delete(e),delete this.store.state[e])}},{key:"hasModel",value:function(e){return!!this.models.get(e)}},{key:"replaceModel",value:function(e){return this.model(e)}},{key:"run",value:function(e){var r=this,i=e.g,a=e.state,n=e.params,s=e.model;return new Promise(function(e,t){var u=i(n,{call:_call.default,all:_all.default,race:_race.default,select:(0,_select.default)(a),put:(0,_put.default)({state:a[s.namespace],params:n,model:s,run:r.run.bind(r)})});(function n(s){return new Promise(function(t,r){function i(e){n(e).then(function(){t()}).catch(function(e){u.throw(e),r(e)})}var e=u.next(s),a=e.value;e.done?t():a instanceof Promise?a.then(function(e){i(e)}).catch(function(e){u.throw(e),r(e)}):i(a)})})().then(function(){e()}).catch(function(){t()})})}},{key:"initSubscriptions",value:function(e){var t=this,r=e.subscriptions,i=void 0===r?{}:r;i&&Object.values(i).forEach(function(e){e({dispatch:t.store.dispatch,history:t.history})})}},{key:"clearUnSubscriptions",value:function(e){var t=e.unsubscriptions,r=void 0===t?{}:t;r&&Object.values(r).forEach(function(e){e()})}},{key:"init",value:function(e){var t=e.namespace,r=e.state,i={};Object.keys(e.effects).forEach(function(e){i["".concat(t,"/").concat(e)]=!1}),Object.assign(this.store.state,(0,_defineProperty2.default)({loading:Object.assign(this.store.state.loading||{global:!1},i)},t,[t]in this.store.state?this.store.state[t]:r)),this.initSubscriptions(e)}},{key:"isGlobalLoading",value:function(e,t){for(var r=e.namespace,i=Object.keys(e.effects),a=!1,n=this.store.state.loading,s=0,u=i;s<u.length;s++){var o=u[s],l="".concat(r,"/").concat(o);l!==t&&n[l]&&(a=!0)}return a}},{key:"before",value:function(e){var r=e.state,i=e.action;return new Promise(function(e){var t=i.type;e(Object.assign(r,{loading:Object.assign(r.loading,(0,_defineProperty2.default)({global:!0},t,!0))}))})}},{key:"after",value:function(e){var l=this,c=e.state,f=e.action;return new Promise(function(r){var e,i=f.type,t=(f.ins,f.success,(0,_objectWithoutProperties2.default)(f,["type","ins","success"])),a=i.split("/"),n=(0,_slicedToArray2.default)(a,2),s=n[0],u=n[1],o=l.models.get(s);o?(e=o.effects[u],l.run({g:e,state:c,params:t,model:o}).then(function(){var e,t=Object.assign(c,(e={},(0,_defineProperty2.default)(e,s,o.state),(0,_defineProperty2.default)(e,"loading",Object.assign(l.store.state.loading,(0,_defineProperty2.default)({global:l.isGlobalLoading(o,i)},i,!1))),e));r(t)})):r(c)})}}]),e}(),_default=function(){return new Saga};exports.default=_default;
//# sourceMappingURL=index.js.map
