{"version":3,"file":"index.js","sources":["middleware/saga/index.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _call = _interopRequireDefault(require(\"./call\"));\n\nvar _all = _interopRequireDefault(require(\"./all\"));\n\nvar _race = _interopRequireDefault(require(\"./race\"));\n\nvar _select = _interopRequireDefault(require(\"./select\"));\n\nvar _put = _interopRequireDefault(require(\"./put\"));\n\nvar _history = _interopRequireDefault(require(\"./history\"));\n\nvar _immutable = _interopRequireDefault(require(\"../../util/immutable\"));\n\n/**\r\n * Saga\r\n * @class Saga\r\n * @classdesc Saga\r\n */\nvar Saga = /*#__PURE__*/function () {\n  function Saga() {\n    (0, _classCallCheck2[\"default\"])(this, Saga);\n    this.models = new Map();\n    this.history = _history[\"default\"];\n  }\n  /**\r\n   * model - 添加一个model\r\n   * @param model\r\n   * @return {boolean}\r\n   */\n\n\n  (0, _createClass2[\"default\"])(Saga, [{\n    key: \"model\",\n    value: function model(_model) {\n      if (!_model) return false;\n      this.clearUnSubscriptions(_model);\n      this.models.set(_model.namespace, _model);\n      this.init(_model);\n      return true;\n    }\n    /**\r\n     * unmodel - 注销一个model\r\n     * @param namespace\r\n     */\n\n  }, {\n    key: \"unmodel\",\n    value: function unmodel(namespace) {\n      var model = this.models.get(namespace);\n\n      if (model) {\n        this.clearUnSubscriptions(model);\n        this.models[\"delete\"](namespace);\n        delete this.store.state[namespace];\n      }\n    }\n    /**\r\n     * hasModel - 是否有指定model\r\n     * @param namespace\r\n     * @return {boolean}\r\n     */\n\n  }, {\n    key: \"hasModel\",\n    value: function hasModel(namespace) {\n      return !!this.models.get(namespace);\n    }\n    /**\r\n     * replacemodal - 替换一个model\r\n     * @param model\r\n     */\n\n  }, {\n    key: \"replaceModel\",\n    value: function replaceModel(model) {\n      return this.model(model);\n    }\n    /**\r\n     * run - 运行generator\r\n     * @param g - 生成器函数类\r\n     * @param state - store的state\r\n     * @param params - action的参数\r\n     * @param model - 模型\r\n     */\n\n  }, {\n    key: \"run\",\n    value: function run(_ref) {\n      var _this = this;\n\n      var g = _ref.g,\n          state = _ref.state,\n          params = _ref.params,\n          model = _ref.model;\n      return new Promise(function (resolve, reject) {\n        // 获取指针\n        var generator = g(params, {\n          call: _call[\"default\"],\n          all: _all[\"default\"],\n          race: _race[\"default\"],\n          select: (0, _select[\"default\"])(_immutable[\"default\"].cloneDeep(state)),\n          put: (0, _put[\"default\"])({\n            state: state[model.namespace],\n            params: params,\n            model: model,\n            run: _this.run.bind(_this)\n          }) // tack: null,\n\n        });\n        /**\r\n         * task\r\n         * @param data\r\n         */\n\n        function next(data) {\n          return new Promise(function (s, e) {\n            /**\r\n             * sucess\r\n             * @param neginParams\r\n             */\n            function nextBegin(neginParams) {\n              next(neginParams).then(function () {\n                s();\n              })[\"catch\"](function (err) {\n                generator[\"throw\"](err);\n                e(err);\n              });\n            }\n            /**\r\n             * 拿一个\r\n             * call\r\n             * put\r\n             * select\r\n             */\n\n\n            var _generator$next = generator.next(data),\n                value = _generator$next.value,\n                done = _generator$next.done;\n\n            if (!done) {\n              if (value instanceof Promise) {\n                value.then(function (res) {\n                  nextBegin(res);\n                })[\"catch\"](function (err) {\n                  generator[\"throw\"](err);\n                  e(err);\n                });\n              } else {\n                nextBegin(value);\n              }\n            } else {\n              s();\n            }\n          });\n        }\n\n        next().then(function () {\n          // 所有任务都完成\n          resolve();\n        })[\"catch\"](function () {\n          reject();\n        });\n      });\n    }\n    /**\r\n     * initSubscriptions\r\n     * @param model\r\n     */\n\n  }, {\n    key: \"initSubscriptions\",\n    value: function initSubscriptions(model) {\n      var _this2 = this;\n\n      var _model$subscriptions = model.subscriptions,\n          subscriptions = _model$subscriptions === void 0 ? {} : _model$subscriptions;\n\n      if (subscriptions) {\n        var values = Object.values(subscriptions);\n        values.forEach(function (v) {\n          v({\n            dispatch: _this2.store.dispatch,\n            history: _this2.history\n          });\n        });\n      }\n    }\n    /**\r\n     * clearUnSubscriptions\r\n     * @param model\r\n     */\n\n  }, {\n    key: \"clearUnSubscriptions\",\n    value: function clearUnSubscriptions(model) {\n      var _model$unsubscription = model.unsubscriptions,\n          unsubscriptions = _model$unsubscription === void 0 ? {} : _model$unsubscription;\n\n      if (unsubscriptions) {\n        var values = Object.values(unsubscriptions);\n        values.forEach(function (v) {\n          v();\n        });\n      }\n    }\n    /**\r\n     * init - 初始化所有model的state数据到store中\r\n     * @param model\r\n     */\n\n  }, {\n    key: \"init\",\n    value: function init(model) {\n      var namespace = model.namespace,\n          state = model.state;\n      var modelEffectsLoading = {};\n      var effectsKeys = Object.keys(model.effects);\n      effectsKeys.forEach(function (k) {\n        modelEffectsLoading[\"\".concat(namespace, \"/\").concat(k)] = false;\n      });\n      Object.assign(this.store.state, (0, _defineProperty2[\"default\"])({\n        loading: Object.assign(this.store.state.loading || {\n          global: false\n        }, modelEffectsLoading)\n      }, namespace, [namespace] in this.store.state ? this.store.state[namespace] : state));\n      this.initSubscriptions(model);\n    }\n  }, {\n    key: \"isGlobalLoading\",\n    value: function isGlobalLoading(model, type) {\n      var namespace = model.namespace;\n      var effectsKeys = Object.keys(model.effects);\n      var globalLoading = false;\n      var loading = this.store.state.loading;\n\n      for (var _i = 0, _effectsKeys = effectsKeys; _i < _effectsKeys.length; _i++) {\n        var key = _effectsKeys[_i];\n        var curType = \"\".concat(namespace, \"/\").concat(key);\n\n        if (curType !== type) {\n          if (loading[curType]) {\n            globalLoading = true;\n          }\n        }\n      }\n\n      return globalLoading;\n    }\n    /**\r\n     * before\r\n     * @param state - store的数据\r\n     * @param action\r\n     * @return Promise\r\n     */\n\n  }, {\n    key: \"before\",\n    value: function before(_ref2) {\n      var state = _ref2.state,\n          action = _ref2.action;\n      return new Promise(function (resolve) {\n        var type = action.type;\n        resolve(Object.assign(state, {\n          loading: Object.assign(state.loading, (0, _defineProperty2[\"default\"])({\n            global: true\n          }, type, true))\n        }));\n      });\n    }\n    /**\r\n     * after\r\n     * @param state\r\n     * @param action\r\n     * @return Promise\r\n     */\n\n  }, {\n    key: \"after\",\n    value: function after(_ref3) {\n      var _this3 = this;\n\n      var state = _ref3.state,\n          action = _ref3.action;\n      return new Promise(function (resolve) {\n        var type = action.type,\n            ins = action.ins,\n            success = action.success,\n            params = (0, _objectWithoutProperties2[\"default\"])(action, [\"type\", \"ins\", \"success\"]);\n\n        var _type$split = type.split('/'),\n            _type$split2 = (0, _slicedToArray2[\"default\"])(_type$split, 2),\n            namespace = _type$split2[0],\n            effect = _type$split2[1]; // 根据命名空间获取model\n\n\n        var model = _this3.models.get(namespace);\n\n        if (model) {\n          // 获取effects的g\n          var g = model.effects[effect]; // 迭代model的effects\n\n          _this3.run({\n            g: g,\n            state: state,\n            params: params,\n            model: model\n          }).then(function () {\n            var _Object$assign4;\n\n            // model的返回\n            var result = Object.assign(state, (_Object$assign4 = {}, (0, _defineProperty2[\"default\"])(_Object$assign4, namespace, model.state), (0, _defineProperty2[\"default\"])(_Object$assign4, \"loading\", Object.assign(_this3.store.state.loading, (0, _defineProperty2[\"default\"])({\n              global: _this3.isGlobalLoading(model, type)\n            }, type, false))), _Object$assign4));\n            resolve(result);\n          });\n        } else {\n          // 没有model的返回\n          resolve(state);\n        }\n      });\n    }\n  }]);\n  return Saga;\n}();\n\nvar _default = function _default() {\n  return new Saga();\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_slicedToArray2","_objectWithoutProperties2","_defineProperty2","_classCallCheck2","_createClass2","_call","_all","_race","_select","_put","_history","_immutable","Saga","this","models","Map","history","key","_model","clearUnSubscriptions","set","namespace","init","model","get","store","state","_ref","_this","g","params","Promise","resolve","reject","generator","call","all","race","select","cloneDeep","put","run","bind","next","data","s","e","nextBegin","neginParams","then","err","_generator$next","done","res","_this2","_model$subscriptions","subscriptions","values","forEach","v","dispatch","_model$unsubscription","unsubscriptions","modelEffectsLoading","keys","effects","k","concat","assign","loading","global","initSubscriptions","type","effectsKeys","globalLoading","_i","_effectsKeys","length","curType","_ref2","action","_ref3","_this3","ins","success","_type$split","split","_type$split2","effect","_Object$assign4","result","isGlobalLoading","_default"],"mappings":"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"}