{"version":3,"file":"serviceregister.js","sources":["middleware/saga/serviceregister.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nrequire(\"core-js/modules/es.array.concat\");\n\nrequire(\"core-js/modules/es.array.for-each\");\n\nrequire(\"core-js/modules/es.array.map\");\n\nrequire(\"core-js/modules/es.object.keys\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nrequire(\"regenerator-runtime/runtime\");\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _react = require(\"../../react\");\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar sage;\nvar Config = {};\n/**\n * ServiceRegister\n * @class ServiceRegister\n * @classdesc 服务的注册\n * 1.自动生成数据流的mapDispatchToProps映射\n * 2.自动生成数据流的mapStateToProps映射\n * 3.自动生成数据流的Model\n */\n\nvar _default = {\n  /**\n   * initConfig - 服务注册初始化\n   * - namespace: service的实例\n   * property: model的namespace，也可以理解为模块名称\n   * value: value为Service的实例对象\n   * @param config\n   */\n  initConfig: function initConfig(config) {\n    Config = config;\n  },\n\n  /**\n   * addConfig\n   * @description - 添加一个服务注册\n   * @param {string} key\n   * @param {object} config\n   */\n  addConfig: function addConfig(key, config) {\n    Config[key] = config;\n  },\n\n  /**\n   * setSage - 设置Sage实例\n   * @param ins Sage\n   */\n  setSage: function setSage(ins) {\n    sage = ins;\n  },\n\n  /**\n   * mapStateToProps - 自动生成mapStateToProps\n   * @param {Array} - namespaces\n   * @param {Object} - state 数据流的数据\n   * @return {Object} - mapStateToProps的映射\n   * 映射namespace到Props\n   * 映射loading到Props\n   */\n  mapStateToProps: function mapStateToProps(_ref) {\n    var namespaces = _ref.namespaces,\n        state = _ref.state;\n    var props = {\n      // [namespace]: state[namespace],\n      loading: state.loading\n      /* .global */\n\n    };\n\n    if (namespaces && namespaces.length) {\n      namespaces.forEach(function (namespace) {\n        props[namespace] = state[namespace];\n      });\n    }\n\n    return props;\n  },\n\n  /**\n   * mapDispatchToProps - 自动生成mapDispatchToProps\n   * @param {Array<String>} - namespaces - 模块的集合\n   * @param {Function} - dispatch\n   * @return {Object} - mapDispatchToProps映射\n   */\n  mapDispatchToProps: function mapDispatchToProps(_ref2) {\n    var namespaces = _ref2.namespaces,\n        dispatch = _ref2.dispatch;\n    // service的实例\n    var mapDispatchToProps = {};\n    var keys = [];\n\n    if (!namespaces || !namespaces.length) {\n      // 如果不传递模块集合或者模块集合为空数组，则生成所有Service的方法隐射\n      keys = Object.keys(Config);\n    } else {\n      keys = namespaces;\n    }\n\n    keys.forEach(function (namespace) {\n      var Service = Config[namespace];\n      Object.keys(Service).forEach(function (key) {\n        if (key !== 'default') {\n          // methodName是namespace + 接口方法名首字母大写\n          // 例子 namespace是todolist Service中有fetchList接口\n          // 则方法名为todolistFetchList\n          var methodName = \"\".concat(namespace).concat(key.charAt(0).toUpperCase()).concat(key.substring(1));\n          var type = \"\".concat(namespace, \"/\").concat(key); // params必须是对象且只有一个对象\n\n          mapDispatchToProps[methodName] = function (params) {\n            return dispatch(_objectSpread({\n              type: type\n            }, params));\n          };\n        }\n      });\n    });\n    return mapDispatchToProps;\n  },\n\n  /**\n   * model - 生成Service对应的Model\n   * 此方默认处理Service中的所有接口，默认生成的Effect只调用接口，\n   * 把接口返回值注入到以方法名为Key，返回的dataKey为数据的数据流中，且在model的namespace键中创建\n   * 例如：\n   * 假定model的namsespace为todolist\n   * Service中有ferchList方法\n   * Model的处理为\n   * 1.调用fetchList\n   * 2.将返回值放入 {\n   *    todolist:{\n   *      fetchList: 数据\n   *    }\n   * }\n   * @param namespace\n   * @return {{getDefaultState: (function(): {}), effects: {}, namespace: *, reducers: {receive(*, {payload: *}): *}, state: {}}} - Model\n   */\n  model: function model(namespace) {\n    // service的实例\n    var Service = Config[namespace];\n    var keys = Object.keys(Service);\n    var defaultState = {};\n    keys.forEach(function (key) {\n      if (key !== 'default') {\n        defaultState[key] = Service[key].defaultResult();\n      }\n    }); // 模型\n\n    var model = {\n      // namespace\n      namespace: namespace,\n      // effects\n      effects: {},\n      state: _objectSpread({}, defaultState),\n      getDefaultState: function getDefaultState() {\n        return _objectSpread({}, defaultState);\n      },\n      // reducers\n      reducers: {\n        receive: function receive(state, _ref3) {\n          var payload = _ref3.payload;\n          return _objectSpread(_objectSpread({}, state), payload);\n        }\n      }\n    }; // 所有除了default\n\n    keys.forEach(function (key) {\n      if (key !== 'default') {\n        // params是调用mapDispatchToProps的参数\n        // success是回调函数\n        // eslint-disable-next-line func-names\n        model.effects[key] = /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(params, _ref4) {\n          var call, put, response, _Service$default, codeKey, codeSuccessKey, dataKey, _response;\n\n          return _regenerator[\"default\"].wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  call = _ref4.call, put = _ref4.put;\n                  // console.log('CTSJ-STATE----',response);\n                  // Service中的默认导出必须有的键\n                  // codeKey为状态域\n                  // codeSuccessKey为状态域中成功标识\n                  // dataKey为数据域\n                  _Service$default = Service[\"default\"], codeKey = _Service$default.codeKey, codeSuccessKey = _Service$default.codeSuccessKey, dataKey = _Service$default.dataKey;\n                  _context.prev = 2;\n                  _context.next = 5;\n                  return call(Service[key].call, params);\n\n                case 5:\n                  response = _context.sent;\n                  _context.next = 11;\n                  break;\n\n                case 8:\n                  _context.prev = 8;\n                  _context.t0 = _context[\"catch\"](2);\n                  response = (_response = {}, (0, _defineProperty2[\"default\"])(_response, codeKey, codeSuccessKey), (0, _defineProperty2[\"default\"])(_response, dataKey, Service[key].defaultResult()), _response);\n\n                case 11:\n                  if (!(response[codeKey] === codeSuccessKey)) {\n                    _context.next = 14;\n                    break;\n                  }\n\n                  _context.next = 14;\n                  return put({\n                    type: 'receive',\n                    payload: (0, _defineProperty2[\"default\"])({}, key, response[dataKey])\n                  });\n\n                case 14:\n                  return _context.abrupt(\"return\", response);\n\n                case 15:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee, null, [[2, 8]]);\n        });\n      }\n    });\n    return model;\n  },\n\n  /**\n   * 加入自动清除的connect\n   * @param serviceNames\n   * @return {function(*=, *=): function(*=): *}\n   */\n  connect: function connect(serviceNames) {\n    var clearGroup = serviceNames.map(function (serviceName) {\n      var model = sage.getModel(serviceName);\n      var defaultState = model && 'getDefaultState' in model ? model.getDefaultState() : {};\n      return {\n        type: \"\".concat(serviceName, \"/receive\"),\n        defaultState: defaultState\n      };\n    });\n    return function (mapStateToProps, mapDispatchToProps) {\n      return function (Component) {\n        return (0, _react.connect)(mapStateToProps, mapDispatchToProps)(Component, {\n          isClear: true,\n          clearGroup: clearGroup\n        });\n      };\n    };\n  }\n};\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_regenerator","sage","_defineProperty2","_react","ownKeys","object","enumerableOnly","symbols","keys","getOwnPropertySymbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","Config","_default","initConfig","config","addConfig","setSage","ins","mapStateToProps","_ref","namespaces","state","props","loading","namespace","mapDispatchToProps","_ref2","dispatch","Service","methodName","type","concat","charAt","toUpperCase","substring","params","model","defaultState","defaultResult","effects","getDefaultState","reducers","receive","_ref3","payload","mark","_callee","_ref4","put","response","codeKey","codeSuccessKey","dataKey","_response","wrap","_context","prev","next","call","_Service$default","sent","t0","abrupt","stop","connect","serviceNames","clearGroup","map","serviceName","getModel","Component","isClear"],"mappings":"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"}