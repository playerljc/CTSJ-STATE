{"version":3,"sources":["middleware/saga/serviceregister.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","Config","_regenerator","_defineProperty2","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","_default","initConfig","config","mapStateToProps","_ref","namespaces","state","props","loading","namespace","mapDispatchToProps","_ref2","dispatch","Service","methodName","concat","charAt","toUpperCase","substring","type","params","assign","model","effects","reducers","receive","_ref3","payload","mark","_callee","_ref4","call","put","response","_Service$default","codeKey","codeSuccessKey","dataKey","wrap","_context","prev","next","sent","stop"],"mappings":"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","file":"serviceregister.js","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar Config;\n/**\r\n * ServiceRegister\r\n * @class ServiceRegister\r\n * @classdesc 服务的注册\r\n * 1.自动生成数据流的mapDispatchToProps映射\r\n * 2.自动生成数据流的mapStateToProps映射\r\n * 3.自动生成数据流的Model\r\n */\n\nvar _default = {\n  /**\r\n   * initConfig - 服务注册初始化\r\n   * @param {Object} - config\r\n   * - namespace: service的实例\r\n   * property: model的namespace，也可以理解为模块名称\r\n   * value: value为Service的实例对象\r\n   */\n  initConfig: function initConfig(config) {\n    Config = config;\n  },\n\n  /**\r\n   * mapStateToProps - 自动生成mapStateToProps\r\n   * @param {Array} - namespaces\r\n   * @param {Object} - state 数据流的数据\r\n   * @return {Object} - mapStateToProps的映射\r\n   * 映射namespace到Props\r\n   * 映射loading到Props\r\n   */\n  mapStateToProps: function mapStateToProps(_ref) {\n    var namespaces = _ref.namespaces,\n        state = _ref.state;\n    var props = {\n      // [namespace]: state[namespace],\n      loading: state.loading\n      /*.global*/\n\n    };\n\n    if (namespaces && namespaces.length) {\n      namespaces.forEach(function (namespace) {\n        props[namespace] = state[namespace];\n      });\n    }\n\n    return props;\n  },\n\n  /**\r\n   * mapDispatchToProps - 自动生成mapDispatchToProps\r\n   * @param {Array<String>} - namespaces - 模块的集合\r\n   * @param {Function} - dispatch\r\n   * @return {Object} - mapDispatchToProps映射\r\n   */\n  mapDispatchToProps: function mapDispatchToProps(_ref2) {\n    var namespaces = _ref2.namespaces,\n        dispatch = _ref2.dispatch;\n    // service的实例\n    var mapDispatchToProps = {};\n    var keys = [];\n\n    if (!namespaces || !namespaces.length) {\n      // 如果不传递模块集合或者模块集合为空数组，则生成所有Service的方法隐射\n      keys = Object.keys(Config);\n    } else {\n      keys = namespaces;\n    }\n\n    keys.forEach(function (namespace) {\n      var Service = Config[namespace];\n      Object.keys(Service).forEach(function (key) {\n        if (key !== 'default') {\n          // methodName是namespace + 接口方法名首字母大写\n          // 例子 namespace是todolist Service中有fetchList接口\n          // 则方法名为todolistFetchList\n          var methodName = \"\".concat(namespace).concat(key.charAt(0).toUpperCase()).concat(key.substring(1));\n          var type = \"\".concat(namespace, \"/\").concat(key); // params必须是对象且只有一个对象\n\n          mapDispatchToProps[methodName] = function (params) {\n            return dispatch(Object.assign({\n              type: type\n            }, params));\n          };\n        }\n      });\n    });\n    return mapDispatchToProps;\n  },\n\n  /**\r\n   * model - 生成Service对应的Model\r\n   * @param {String} - namespace\r\n   * @return {Object} - Model\r\n   * 此方默认处理Service中的所有接口，默认生成的Effect只调用接口，\r\n   * 把接口返回值注入到以方法名为Key，返回的dataKey为数据的数据流中，且在model的namespace键中创建\r\n   * 例如：\r\n   * 假定model的namsespace为todolist\r\n   * Service中有ferchList方法\r\n   * Model的处理为\r\n   * 1.调用fetchList\r\n   * 2.将返回值放入 {\r\n   *    todolist:{\r\n   *      fetchList: 数据\r\n   *    }\r\n   * }\r\n   */\n  model: function model(namespace) {\n    // service的实例\n    var Service = Config[namespace]; // 模型\n\n    var model = {\n      // namespace\n      namespace: namespace,\n      // effects\n      effects: {},\n      // reducers\n      reducers: {\n        receive: function receive(state, _ref3) {\n          var payload = _ref3.payload;\n          return _objectSpread({}, state, {}, payload);\n        }\n      }\n    }; // 所有除了default\n\n    Object.keys(Service).forEach(function (key) {\n      if (key !== 'default') {\n        // params是调用mapDispatchToProps的参数\n        // success是回调函数\n        model.effects[key] = /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(params, _ref4) {\n          var call, put, response, _Service$default, codeKey, codeSuccessKey, dataKey;\n\n          return _regenerator[\"default\"].wrap(function _callee$(_context) {\n            while (1) {\n              switch (_context.prev = _context.next) {\n                case 0:\n                  call = _ref4.call, put = _ref4.put;\n                  _context.next = 3;\n                  return call(Service[key], params);\n\n                case 3:\n                  response = _context.sent;\n                  // Service中的默认导出必须有的键\n                  // codeKey为状态域\n                  // codeSuccessKey为状态域中成功标识\n                  // dataKey为数据域\n                  _Service$default = Service[\"default\"], codeKey = _Service$default.codeKey, codeSuccessKey = _Service$default.codeSuccessKey, dataKey = _Service$default.dataKey;\n\n                  if (!(response[codeKey] === codeSuccessKey)) {\n                    _context.next = 8;\n                    break;\n                  }\n\n                  _context.next = 8;\n                  return put({\n                    type: 'receive',\n                    payload: (0, _defineProperty2[\"default\"])({}, key, response[dataKey])\n                  });\n\n                case 8:\n                case \"end\":\n                  return _context.stop();\n              }\n            }\n          }, _callee);\n        });\n      }\n    });\n    return model;\n  }\n};\nexports[\"default\"] = _default;"]}