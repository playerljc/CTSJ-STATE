{"version":3,"file":"useSagaState.js","sources":["react/useSagaState.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nrequire(\"core-js/modules/es.symbol\");\n\nrequire(\"core-js/modules/es.symbol.description\");\n\nrequire(\"core-js/modules/es.array.concat\");\n\nrequire(\"core-js/modules/es.array.for-each\");\n\nrequire(\"core-js/modules/es.function.bind\");\n\nrequire(\"core-js/modules/es.object.to-string\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _slicedToArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _toConsumableArray2 = _interopRequireDefault(require(\"@babel/runtime/helpers/toConsumableArray\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _react = require(\"react\");\n\nvar _createStore = _interopRequireDefault(require(\"../state/createStore\"));\n\nvar _applyMiddleware = _interopRequireDefault(require(\"../state/applyMiddleware\"));\n\nvar _middleware = require(\"../middleware\");\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n/**\n * SagaState\n */\nvar SagaState = /*#__PURE__*/function () {\n  /**\n   * constructor\n   * @param params\n   * {\n   *  initialState - state初始化数据\n   *  models - 所有的模型\n   *  mapState - mapState\n   *  mapDispatch - mapDispatch\n   *  ref - React组件的this\n   *  middleWares - 中间件\n   *  reducer - reducer\n   * }\n   */\n  function SagaState(params) {\n    (0, _classCallCheck2[\"default\"])(this, SagaState);\n    var initialState = params.initialState,\n        _params$models = params.models,\n        models = _params$models === void 0 ? [] : _params$models,\n        middleWares = params.middleWares,\n        reducer = params.reducer;\n    this.params = params; // saga对象\n\n    this.saga = (0, _middleware.createSagaMiddleware)(); // store对象\n\n    this.store = (0, _createStore[\"default\"])(reducer, initialState, _applyMiddleware[\"default\"].apply(void 0, (0, _toConsumableArray2[\"default\"])(middleWares).concat([this.saga]))); // 注册models\n\n    this.registerModels({\n      models: models,\n      saga: this.saga\n    });\n  }\n  /**\n   * registerModels\n   * @param models\n   * @param saga\n   */\n\n\n  (0, _createClass2[\"default\"])(SagaState, [{\n    key: \"registerModels\",\n    value: function registerModels(_ref) {\n      var saga = _ref.saga,\n          models = _ref.models;\n      models.forEach(function (model) {\n        saga.model(model);\n      });\n    }\n    /**\n     * mapTo\n     * @return {{dispatch: {}, props: {}}}\n     */\n\n  }, {\n    key: \"mapTo\",\n    value: function mapTo() {\n      var _this$params = this.params,\n          mapState = _this$params.mapState,\n          mapDispatch = _this$params.mapDispatch;\n      var dispatch = {}; // mapDispatchToProps\n\n      if (mapDispatch) {\n        // eslint-disable-next-line @typescript-eslint/no-use-before-define\n        dispatch = mapDispatch(this.store.dispatch.bind(this.store));\n      }\n\n      var props = {}; // mapStateToProps\n\n      if (mapState) {\n        // eslint-disable-next-line @typescript-eslint/no-use-before-define\n        props = mapState(this.getState());\n      }\n\n      return {\n        dispatch: dispatch,\n        props: props\n      };\n    }\n    /**\n     * getReducer\n     * @return {function(...[*]=)}\n     */\n    // eslint-disable-next-line class-methods-use-this\n\n  }, {\n    key: \"getReducer\",\n    value: function getReducer() {\n      return function (state, action) {\n        var type = action.type,\n            _action$params = action.params,\n            props = _action$params.props,\n            dispatch = _action$params.dispatch,\n            dispatchAction = _action$params.action;\n\n        if (type === 'setState') {\n          return _objectSpread(_objectSpread(_objectSpread(_objectSpread({}, state), props), dispatch), {}, (0, _defineProperty2[\"default\"])({}, Symbol[\"for\"]('action'), dispatchAction));\n        }\n\n        return state;\n      };\n    }\n    /**\n     * getInitial\n     * @return {{}}\n     */\n\n  }, {\n    key: \"getInitial\",\n    value: function getInitial() {\n      var _this$mapTo = this.mapTo(),\n          props = _this$mapTo.props,\n          dispatch = _this$mapTo.dispatch;\n\n      return _objectSpread(_objectSpread({}, props), dispatch);\n    }\n    /**\n     * subscribe\n     * @param dispatch\n     * @return {function(...[*]=)}\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(dispatch) {\n      this.onSubscribe = this.onSubscribe.bind(this, dispatch);\n      return this.store.subscribe(this.onSubscribe);\n    }\n    /**\n     * getState\n     * @return {{}}\n     */\n\n  }, {\n    key: \"getState\",\n    value: function getState() {\n      return this.store.getState();\n    }\n    /**\n     * onSubscribe\n     * @param reducerDispatch\n     * @param action\n     */\n\n  }, {\n    key: \"onSubscribe\",\n    value: function onSubscribe(reducerDispatch, action) {\n      var _this$mapTo2 = this.mapTo(),\n          props = _this$mapTo2.props,\n          dispatch = _this$mapTo2.dispatch;\n\n      reducerDispatch({\n        type: 'setState',\n        params: {\n          props: props,\n          dispatch: dispatch,\n          action: action\n        }\n      });\n    }\n  }]);\n  return SagaState;\n}();\n\nvar _default = function _default(params) {\n  var ref = (0, _react.useRef)(new SagaState(params));\n\n  var _useReducer = (0, _react.useReducer)(ref.current.getReducer(), ref.current.getInitial()),\n      _useReducer2 = (0, _slicedToArray2[\"default\"])(_useReducer, 2),\n      state = _useReducer2[0],\n      dispatch = _useReducer2[1]; // 用来监控state的变化\n\n\n  (0, _react.useEffect)(function () {\n    // 用action符号取出action\n    var actionKey = Symbol[\"for\"]('action'); // 调用action的success\n\n    if (state[actionKey] && state[actionKey].success) {\n      state[actionKey].success();\n    }\n  }, [state]); // 只注册一次store的subscribe\n\n  (0, _react.useEffect)(function () {\n    // eslint-disable-next-line @typescript-eslint/no-use-before-define\n    var unsubscribe = ref.current.subscribe(dispatch);\n    return function () {\n      unsubscribe();\n    };\n  }, []);\n  return state;\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_slicedToArray2","_defineProperty2","_toConsumableArray2","_classCallCheck2","_createClass2","_react","_createStore","_applyMiddleware","_middleware","ownKeys","object","enumerableOnly","symbols","keys","getOwnPropertySymbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","SagaState","params","this","initialState","_params$models","models","middleWares","reducer","saga","createSagaMiddleware","store","concat","registerModels","_ref","model","_this$params","mapState","mapDispatch","dispatch","bind","props","getState","state","action","type","_action$params","dispatchAction","Symbol","_this$mapTo","mapTo","onSubscribe","subscribe","reducerDispatch","_this$mapTo2","_default","ref","useRef","_useReducer","useReducer","current","getReducer","getInitial","_useReducer2","useEffect","actionKey","success","unsubscribe"],"mappings":"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"}