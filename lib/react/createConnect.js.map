{"version":3,"file":"createConnect.js","sources":["react/createConnect.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nrequire(\"core-js/modules/es.array.for-each\");\n\nrequire(\"core-js/modules/es.function.bind\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _extends2 = _interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _getPrototypeOf2 = _interopRequireDefault(require(\"@babel/runtime/helpers/getPrototypeOf\"));\n\nvar _react = _interopRequireDefault(require(\"react\"));\n\nvar _Context = require(\"./Context\");\n\nvar _immutable = _interopRequireDefault(require(\"../util/immutable\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2[\"default\"])(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2[\"default\"])(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2[\"default\"])(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Date.prototype.toString.call(Reflect.construct(Date, [], function () {})); return true; } catch (e) { return false; } }\n\n// import { isArray, isObject } from '../util';\n\n/**\n * createConnect\n * @param mapStateToProps\n * @param mapDispatchToProps\n */\nvar _default = function _default(mapStateToProps, mapDispatchToProps) {\n  return (\n    /**\n     * ConnectHOC - 一个提供store处理的工厂类\n     *   isClear: boolean - 是否清除页面用到的store数据\n     *   clearGroups: [\n     *     {\n     *        type: string - 清除页面store数据dispatch的type\n     *        defaultState: object - 清除页面store数据的assign\n     *     }\n     *   ]\n     * }\n     * @param Component\n     * @param Config\n     */\n    function (Component, Config) {\n      var CreateConnect = /*#__PURE__*/function (_React$Component) {\n        (0, _inherits2[\"default\"])(CreateConnect, _React$Component);\n\n        var _super = _createSuper(CreateConnect);\n\n        /**\n         * constructor\n         * @param props\n         */\n        function CreateConnect(props) {\n          var _this;\n\n          (0, _classCallCheck2[\"default\"])(this, CreateConnect);\n          _this = _super.call(this, props);\n          _this.ref = /*#__PURE__*/_react[\"default\"].createRef();\n\n          _this.onSubscribe = function (action) {\n            var _assertThisInitialize = (0, _assertThisInitialized2[\"default\"])(_this),\n                store = _assertThisInitialize.store; // store的数据\n\n\n            var state = store.getState(); // 之前state的数据\n\n            _this.setState({\n              state: state\n            }, function () {\n              // 如果是当前实力进行的数据更改才会调用success\n              var success = action.success,\n                  ins = action.ins,\n                  other = (0, _objectWithoutProperties2[\"default\"])(action, [\"success\", \"ins\"]); // console.log('redux进行了数据改变的通知');\n              // console.log(action);\n              // console.log(this.ins);\n              // console.log(this.ins === ins);\n\n              if (success && ins) {\n                // if (/* this.ins */ this?.ref?.current === ins) {\n                success.call(ins, _immutable[\"default\"].cloneDeep(other)); // }\n              }\n            });\n          };\n\n          _this.state = {\n            state: null\n          };\n          return _this;\n        }\n        /**\n         * componentDidMount\n         */\n\n\n        (0, _createClass2[\"default\"])(CreateConnect, [{\n          key: \"componentDidMount\",\n          value: function componentDidMount() {\n            var store = this.store; // 注册store的更改事件\n\n            this.unsubscribe = store.subscribe(this.onSubscribe);\n          }\n          /**\n           * componentWillUnmount\n           */\n\n        }, {\n          key: \"componentWillUnmount\",\n          value: function componentWillUnmount() {\n            var _this2 = this;\n\n            // 加入清理页面用到的store的操作\n            if (Config && Config.isClear) {\n              var _Config$clearGroup = Config.clearGroup,\n                  clearGroup = _Config$clearGroup === void 0 ? [] : _Config$clearGroup;\n              clearGroup.forEach(function (_ref) {\n                var _ref$type = _ref.type,\n                    type = _ref$type === void 0 ? '' : _ref$type,\n                    _ref$defaultState = _ref.defaultState,\n                    defaultState = _ref$defaultState === void 0 ? {} : _ref$defaultState;\n\n                _this2.store.dispatch(_objectSpread({\n                  type: type\n                }, defaultState || {}));\n              });\n            }\n\n            this.unsubscribe();\n          }\n          /**\n           * onSubscribe\n           * @param action\n           */\n\n        }, {\n          key: \"render\",\n\n          /**\n           * render\n           * @return {*}\n           */\n          value: function render() {\n            var _this3 = this;\n\n            return /*#__PURE__*/_react[\"default\"].createElement(_Context.ProviderContext.Consumer, null, function (_ref2) {\n              var store = _ref2.store;\n              if (!_this3.store) _this3.store = store; // 将store的数据存储在state中\n\n              var state = _this3.state.state ? _this3.state.state : _this3.store.getState();\n              var dispatch = {}; // mapDispatchToProps\n\n              if (mapDispatchToProps) {\n                dispatch = mapDispatchToProps(_this3.store.dispatch.bind(_this3.store));\n              }\n\n              var props = {}; // mapStateToProps\n\n              if (mapStateToProps) {\n                props = mapStateToProps(state);\n              }\n\n              var allProps = _objectSpread(_objectSpread(_objectSpread(_objectSpread({}, _this3.props), props), dispatch), {}, {\n                dispatch: store.dispatch.bind(store)\n              }); // 如果 Component 是 FunctionComponent 就不赋值ref了\n              // if (isArray(Component)) {\n              //   if (Component.prototype.isReactComponent) {\n              //     allProps.ref = this.props.forwardedRef || React.createRef();\n              //   }\n              // } else if (isObject(Component)) {\n              //   if (Component.constructor.prototype.isReactComponent) {\n              //     allProps.ref = this.props.forwardedRef || React.createRef();\n              //   }\n              // }\n\n\n              return /*#__PURE__*/_react[\"default\"].createElement(Component // ref={(ins) => {\n              //   this.ins = ins;\n              // }}\n              // ref={this.ref}\n              , (0, _extends2[\"default\"])({}, allProps, {\n                ref: _this3.props.forwardedRef || _this3.ref\n              }));\n            });\n          }\n        }]);\n        return CreateConnect;\n      }(_react[\"default\"].Component);\n\n      return /*#__PURE__*/_react[\"default\"].forwardRef(function (props, ref) {\n        return /*#__PURE__*/_react[\"default\"].createElement(CreateConnect, (0, _extends2[\"default\"])({}, props, {\n          forwardedRef: ref\n        }));\n      });\n    }\n  );\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_extends2","_defineProperty2","_objectWithoutProperties2","_classCallCheck2","_createClass2","_assertThisInitialized2","_inherits2","_possibleConstructorReturn2","_getPrototypeOf2","_react","_Context","_immutable","ownKeys","object","enumerableOnly","symbols","keys","getOwnPropertySymbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","_createSuper","Derived","hasNativeReflectConstruct","_isNativeReflectConstruct","NewTarget","Super","result","this","constructor","Reflect","construct","sham","Proxy","Date","prototype","toString","call","e","_default","mapStateToProps","mapDispatchToProps","Component","Config","CreateConnect","_React$Component","_super","props","_this","ref","createRef","onSubscribe","action","state","store","getState","setState","success","ins","other","cloneDeep","unsubscribe","subscribe","_Config$clearGroup","_this2","isClear","clearGroup","_ref","_ref$type","type","_ref$defaultState","defaultState","dispatch","_this3","createElement","ProviderContext","Consumer","_ref2","bind","allProps","forwardedRef","forwardRef"],"mappings":"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"}