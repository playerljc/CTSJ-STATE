{"version":3,"sources":["state/createStore.js"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_objectWithoutProperties2","_classCallCheck2","_createClass2","_immutable","trigger","action","this","listeners","forEach","ins","Store","reducer","_this","preloadedState","arguments","length","undefined","middlewares","state","assign","m","store","key","_this2","Promise","resolveParent","rejectParent","index","cloneState","cloneDeep","next","resolve","reject","before","then","error","_this3","after","_this4","Function","dispatch","bind","runBeforeMiddlewares","beforeCloneState","success","filterAction","call","runAfterMiddlewares","afterCloneState","listener","_this5","push","indexOf","splice","_default"],"mappings":"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","file":"createStore.js","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _immutable = _interopRequireDefault(require(\"../util/immutable\"));\n\n/**\n * trigger\n * @access private\n */\nfunction trigger(action) {\n  var listeners = this.listeners;\n  listeners.forEach(function (ins) {\n    ins(action);\n  });\n}\n/**\n * Store\n * @class Store\n * @classdesc Store\n */\n\n\nvar Store = /*#__PURE__*/function () {\n  /**\n   * constrcutor\n   * @param {Function} - reducer\n   * @param {Object | Array} - preloadedState\n   * @param {Array} - middlewares\n   */\n  function Store(reducer) {\n    var _this = this;\n\n    var preloadedState = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var middlewares = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    (0, _classCallCheck2[\"default\"])(this, Store);\n\n    this.reducer = reducer || function (state) {\n      return state;\n    };\n\n    this.state = Object.assign({}, preloadedState);\n    this.middlewares = middlewares || []; // 给每一个middleware赋值store\n\n    this.middlewares.forEach(function (m) {\n      m.store = _this;\n    });\n    this.listeners = [];\n  }\n  /**\n   * getState\n   * @return {Object}\n   */\n\n\n  (0, _createClass2[\"default\"])(Store, [{\n    key: \"getState\",\n    value: function getState() {\n      return this.state;\n    }\n    /**\n     * runBeforeMiddlewares\n     * @param action\n     * @return {Promise<state>}\n     */\n\n  }, {\n    key: \"runBeforeMiddlewares\",\n    value: function runBeforeMiddlewares(action) {\n      var _this2 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = _this2.middlewares.length - 1; // 整个store的state\n\n        var cloneState = _immutable[\"default\"].cloneDeep(_this2.state);\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index < 0) {\n              resolve();\n            } else {\n              var middleware = _this2.middlewares[index--];\n              middleware.before({\n                state: cloneState,\n                action: action\n              }).then(function (state) {\n                cloneState = state;\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent(cloneState);\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\n     * runAfterMiddlewares\n     * @param action\n     * @return {Promise<state>}\n     */\n\n  }, {\n    key: \"runAfterMiddlewares\",\n    value: function runAfterMiddlewares(action) {\n      var _this3 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = 0;\n\n        var cloneState = _immutable[\"default\"].cloneDeep(_this3.state);\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index >= _this3.middlewares.length) {\n              resolve();\n            } else {\n              var middleware = _this3.middlewares[index++];\n              middleware.after({\n                state: cloneState,\n                action: action\n              }).then(function (state) {\n                cloneState = state;\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent(cloneState);\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\n     * dispatch\n     * @param action\n     */\n\n  }, {\n    key: \"dispatch\",\n    value: function dispatch(action) {\n      var _this4 = this;\n\n      if (action instanceof Function) {\n        action(this.dispatch.bind(this));\n      } else if (this.middlewares.length) {\n        // 如果有middlewares\n        // before\n        this.runBeforeMiddlewares(action).then(function (beforeCloneState) {\n          _this4.state = beforeCloneState; // before的时候去掉action中的success\n\n          var success = action.success,\n              filterAction = (0, _objectWithoutProperties2[\"default\"])(action, [\"success\"]);\n          trigger.call(_this4, filterAction); // detail\n\n          _this4.state = _this4.reducer(_immutable[\"default\"].cloneDeep(_this4.state), action); // after\n\n          _this4.runAfterMiddlewares(action).then(function (afterCloneState) {\n            _this4.state = afterCloneState;\n            trigger.call(_this4, action);\n          });\n        });\n      } else {\n        // 如果没有middlewares\n        this.state = this.reducer(_immutable[\"default\"].cloneDeep(this.state), action);\n        trigger.call(this, action);\n      }\n    }\n    /**\n     * subscribe\n     * @param {Function} - listener\n     * @return {Function}\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(listener) {\n      var _this5 = this;\n\n      this.listeners.push(listener);\n      return function () {\n        var index = _this5.listeners.indexOf(listener);\n\n        if (index !== -1) {\n          _this5.listeners.splice(index, 1);\n        }\n      };\n    }\n  }]);\n  return Store;\n}();\n/**\n * createStore\n * @param {Function} - reducer\n * @param {Object | Array} - preloadedState\n * @param {Array} - middlewares\n * @return {Store}\n */\n\n\nvar _default = function _default(reducer, preloadedState, middlewares) {\n  return new Store(reducer, preloadedState, middlewares);\n};\n\nexports[\"default\"] = _default;"]}