{"version":3,"file":"createStore.js","sources":["state/createStore.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nrequire(\"core-js/modules/es.array.for-each\");\n\nrequire(\"core-js/modules/es.array.index-of\");\n\nrequire(\"core-js/modules/es.array.splice\");\n\nrequire(\"core-js/modules/es.function.bind\");\n\nrequire(\"core-js/modules/es.object.to-string\");\n\nrequire(\"core-js/modules/es.promise\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n/**\n * trigger\n * @access private\n */\nfunction trigger(action) {\n  var listeners = this.listeners;\n  listeners.forEach(function (ins) {\n    ins(action);\n  });\n}\n/**\n * Store - 数据的仓库\n * @class Store\n * @classdesc 数据的仓库\n */\n\n\nvar Store = /*#__PURE__*/function () {\n  /**\n   * constrcutor - Store的构造方法\n   * @param reducer\n   * @param preloadedState\n   * @param middleWares\n   */\n  function Store(reducer) {\n    var _this = this;\n\n    var preloadedState = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var middleWares = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    (0, _classCallCheck2[\"default\"])(this, Store);\n\n    // reducer处理\n    this.reducer = reducer || function (state) {\n      return state;\n    }; // 用缺省值初始化store的数据\n\n\n    this.state = _objectSpread({}, preloadedState); // 所有的中间件\n\n    this.middlewares = middleWares || []; // 给每一个middleware赋值store\n\n    this.middlewares.forEach(function (m) {\n      m.setStore(_this);\n    }); // 对store更新进行订阅(subscribe)的句柄\n\n    this.listeners = [];\n  }\n  /**\n   * getState - 获取store的数据\n   * @return {Object}\n   */\n\n\n  (0, _createClass2[\"default\"])(Store, [{\n    key: \"getState\",\n    value: function getState() {\n      return this.state;\n    }\n    /**\n     * runBeforeMiddleWares - 执行所有中间件的before\n     * @param action - dispatch的action\n     * @return {Promise<state>}\n     */\n\n  }, {\n    key: \"runBeforeMiddleWares\",\n    value: function runBeforeMiddleWares(action) {\n      var _this2 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        // 从后往前执行middleWares\n        var index = _this2.middlewares.length - 1;\n        /**\n         * 执行一次middleWare的runBefore\n         * @return {Promise}\n         */\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            // 所有的middleWare都执行完了\n            if (index < 0) {\n              resolve();\n            } else {\n              // 取出一个middle\n              var middleware = _this2.middlewares[index--]; // 执行middleWare的before\n\n              middleware.before({\n                // 传入的是整个数据\n                state: _this2.state,\n                action: action\n              }).then(function ()\n              /* state */\n              {\n                // cloneState = state;\n                // 继续向前执行middleWare\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        }; // 执行一次middleWare的runBefore\n\n\n        next().then(function () {\n          resolveParent();\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\n     * runAfterMiddleWares - 运行所有中间件的after\n     * @param action - dispatch的action\n     * @return {Promise<state>}\n     */\n\n  }, {\n    key: \"runAfterMiddleWares\",\n    value: function runAfterMiddleWares(action) {\n      var _this3 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = 0;\n\n        var next = function next(result) {\n          return new Promise(function (resolve, reject) {\n            if (index >= _this3.middlewares.length) {\n              resolve(result);\n            } else {\n              var middleware = _this3.middlewares[index++];\n              middleware.after({\n                // 传入的是整个数据\n                state: _this3.state,\n                action: action\n              }).then(function (result1) {\n                next(result1).then(function (result2) {\n                  resolve(result2);\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function (result) {\n          resolveParent(result);\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\n     * dispatch - 进行数据的修改\n     * @param action\n     * @return Promise | Void\n     */\n    // eslint-disable-next-line consistent-return\n\n  }, {\n    key: \"dispatch\",\n    value: function dispatch(action) {\n      var _this4 = this;\n\n      if (action instanceof Function) {\n        action(this.dispatch.bind(this));\n      } // 如果存在中间件\n      else if (this.middlewares.length) {\n          // 如果有middleWares\n          // before 执行所有的middleWare的before\n          return new Promise(function (resolve) {\n            _this4.runBeforeMiddleWares(action).then(function () {\n              // before的时候去掉action中的success\n              var success = action.success,\n                  filterAction = (0, _objectWithoutProperties2[\"default\"])(action, [\"success\"]);\n              trigger.call(_this4, filterAction); // detail 执行所有的Reducer\n\n              _this4.state = _this4.reducer(_this4.state, action); // after 执行所有的middleWare的after\n\n              _this4.runAfterMiddleWares(action).then(function (result) {\n                trigger.call(_this4, action);\n                resolve(result);\n              });\n            });\n          });\n        } else {\n          // 如果没有middleWares\n          // 执行所有的Reducer\n          this.state = this.reducer(this.state, action);\n          trigger.call(this, action);\n        }\n    }\n    /**\n     * subscribe - 对store数据更改的监听\n     * @param listener\n     * @return {Function} - 删除该句柄的方法\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(listener) {\n      var _this5 = this;\n\n      this.listeners.push(listener);\n      return function () {\n        var index = _this5.listeners.indexOf(listener);\n\n        if (index !== -1) {\n          _this5.listeners.splice(index, 1);\n        }\n      };\n    }\n  }]);\n  return Store;\n}();\n/**\n * createStore - 创建一个Store\n * @param reducer\n * @param preloadedState\n * @param middleWares\n * @return {Store}\n */\n\n\nvar _default = function _default(reducer, preloadedState, middleWares) {\n  return new Store(reducer, preloadedState, middleWares);\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_objectWithoutProperties2","_defineProperty2","_classCallCheck2","_createClass2","ownKeys","object","enumerableOnly","symbols","keys","getOwnPropertySymbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","trigger","action","this","listeners","ins","Store","reducer","_this","preloadedState","undefined","middleWares","state","middlewares","m","setStore","_this2","Promise","resolveParent","rejectParent","index","next","resolve","reject","before","then","error","_this3","result","after","result1","result2","_this4","Function","dispatch","bind","runBeforeMiddleWares","success","filterAction","call","runAfterMiddleWares","listener","_this5","indexOf","splice","_default"],"mappings":"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"}