{"version":3,"file":"createStore.js","sources":["state/createStore.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _immutable = _interopRequireDefault(require(\"../util/immutable\"));\n\n/**\r\n * trigger\r\n * @access private\r\n */\nfunction trigger(action) {\n  var listeners = this.listeners;\n  listeners.forEach(function (ins) {\n    ins(action);\n  });\n}\n/**\r\n * Store\r\n * @class Store\r\n * @classdesc Store\r\n */\n\n\nvar Store = /*#__PURE__*/function () {\n  /**\r\n   * constrcutor\r\n   * @param {Function} - reducer\r\n   * @param {Object | Array} - preloadedState\r\n   * @param {Array} - middlewares\r\n   */\n  function Store(reducer) {\n    var _this = this;\n\n    var preloadedState = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var middlewares = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    (0, _classCallCheck2[\"default\"])(this, Store);\n\n    this.reducer = reducer || function (state) {\n      return state;\n    };\n\n    this.state = Object.assign({}, preloadedState);\n    this.middlewares = middlewares || []; // 给每一个middleware赋值store\n\n    this.middlewares.forEach(function (m) {\n      m.store = _this;\n    });\n    this.listeners = [];\n  }\n  /**\r\n   * getState\r\n   * @return {Object}\r\n   */\n\n\n  (0, _createClass2[\"default\"])(Store, [{\n    key: \"getState\",\n    value: function getState() {\n      return this.state;\n    }\n    /**\r\n     * runBeforeMiddlewares\r\n     * @param action\r\n     * @return {Promise<state>}\r\n     */\n\n  }, {\n    key: \"runBeforeMiddlewares\",\n    value: function runBeforeMiddlewares(action) {\n      var _this2 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = _this2.middlewares.length - 1; // 整个store的state\n\n        var cloneState = _this2.state;\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index < 0) {\n              resolve();\n            } else {\n              var middleware = _this2.middlewares[index--];\n              middleware.before({\n                state: cloneState,\n                action: action\n              }).then(function (state) {\n                cloneState = state;\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent(cloneState);\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\r\n     * runAfterMiddlewares\r\n     * @param action\r\n     * @return {Promise<state>}\r\n     */\n\n  }, {\n    key: \"runAfterMiddlewares\",\n    value: function runAfterMiddlewares(action) {\n      var _this3 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = 0;\n        var cloneState = _this3.state;\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index >= _this3.middlewares.length) {\n              resolve();\n            } else {\n              var middleware = _this3.middlewares[index++];\n              middleware.after({\n                state: cloneState,\n                action: action\n              }).then(function (state) {\n                cloneState = state;\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent(cloneState);\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\r\n     * dispatch\r\n     * @param {Object | Function} - action\r\n     */\n\n  }, {\n    key: \"dispatch\",\n    value: function dispatch(action) {\n      var _this4 = this;\n\n      if (action instanceof Function) {\n        action(this.dispatch.bind(this));\n      } else if (this.middlewares.length) {\n        // 如果有middlewares\n        // before\n        this.runBeforeMiddlewares(action).then(function (beforeCloneState) {\n          _this4.state = beforeCloneState; // before的时候去掉action中的success\n\n          var success = action.success,\n              filterAction = (0, _objectWithoutProperties2[\"default\"])(action, [\"success\"]);\n          trigger.call(_this4, filterAction); // detail\n\n          _this4.state = _this4.reducer(_this4.state, action); // after\n\n          _this4.runAfterMiddlewares(action).then(function (afterCloneState) {\n            _this4.state = afterCloneState;\n            trigger.call(_this4, action);\n          });\n        });\n      } else {\n        // 如果没有middlewares\n        this.state = this.reducer(this.state, action);\n        trigger.call(this, action);\n      }\n    }\n    /**\r\n     * subscribe\r\n     * @param {Function} - listener\r\n     * @return {Function}\r\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(listener) {\n      var _this5 = this;\n\n      this.listeners.push(listener);\n      return function () {\n        var index = _this5.listeners.indexOf(listener);\n\n        if (index !== -1) {\n          _this5.listeners.splice(index, 1);\n        }\n      };\n    }\n  }]);\n  return Store;\n}();\n/**\r\n * createStore\r\n * @param {Function} - reducer\r\n * @param {Object | Array} - preloadedState\r\n * @param {Array} - middlewares\r\n * @return {Store}\r\n */\n\n\nvar _default = function _default(reducer, preloadedState, middlewares) {\n  return new Store(reducer, preloadedState, middlewares);\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_objectWithoutProperties2","_classCallCheck2","_createClass2","_immutable","trigger","action","this","listeners","forEach","ins","Store","reducer","_this","preloadedState","arguments","length","undefined","middlewares","state","assign","m","store","key","_this2","Promise","resolveParent","rejectParent","index","cloneState","next","resolve","reject","before","then","error","_this3","after","_this4","Function","dispatch","bind","runBeforeMiddlewares","beforeCloneState","success","filterAction","call","runAfterMiddlewares","afterCloneState","listener","_this5","push","indexOf","splice","_default"],"mappings":"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"}