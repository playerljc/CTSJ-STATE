{"version":3,"file":"createStore.js","sources":["state/createStore.js"],"sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports[\"default\"] = void 0;\n\nvar _objectWithoutProperties2 = _interopRequireDefault(require(\"@babel/runtime/helpers/objectWithoutProperties\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\n/**\r\n * trigger\r\n * @access private\r\n */\nfunction trigger(action) {\n  var listeners = this.listeners;\n  listeners.forEach(function (ins) {\n    ins(action);\n  });\n}\n/**\r\n * Store\r\n * @class Store\r\n * @classdesc Store\r\n */\n\n\nvar Store = /*#__PURE__*/function () {\n  /**\r\n   * constrcutor\r\n   * @param {Function} - reducer\r\n   * @param {Object | Array} - preloadedState\r\n   * @param {Array} - middlewares\r\n   */\n  function Store(reducer) {\n    var _this = this;\n\n    var preloadedState = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var middlewares = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n    (0, _classCallCheck2[\"default\"])(this, Store);\n\n    this.reducer = reducer || function (state) {\n      return state;\n    };\n\n    this.state = Object.assign({}, preloadedState);\n    this.middlewares = middlewares || []; // 给每一个middleware赋值store\n\n    this.middlewares.forEach(function (m) {\n      m.setStore(_this);\n    });\n    this.listeners = [];\n  }\n  /**\r\n   * getState\r\n   * @return {Object}\r\n   */\n\n\n  (0, _createClass2[\"default\"])(Store, [{\n    key: \"getState\",\n    value: function getState() {\n      return this.state;\n    }\n    /**\r\n     * runBeforeMiddlewares\r\n     * @param action\r\n     * @return {Promise<state>}\r\n     */\n\n  }, {\n    key: \"runBeforeMiddlewares\",\n    value: function runBeforeMiddlewares(action) {\n      var _this2 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = _this2.middlewares.length - 1;\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index < 0) {\n              resolve();\n            } else {\n              var middleware = _this2.middlewares[index--];\n              middleware.before({\n                state: _this2.state,\n                action: action\n              }).then(function ()\n              /* state */\n              {\n                // cloneState = state;\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent();\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\r\n     * runAfterMiddlewares\r\n     * @param action\r\n     * @return {Promise<state>}\r\n     */\n\n  }, {\n    key: \"runAfterMiddlewares\",\n    value: function runAfterMiddlewares(action) {\n      var _this3 = this;\n\n      return new Promise(function (resolveParent, rejectParent) {\n        var index = 0;\n\n        var next = function next() {\n          return new Promise(function (resolve, reject) {\n            if (index >= _this3.middlewares.length) {\n              resolve();\n            } else {\n              var middleware = _this3.middlewares[index++];\n              middleware.after({\n                state: _this3.state,\n                action: action\n              }).then(function () {\n                next().then(function () {\n                  resolve();\n                });\n              })[\"catch\"](function (error) {\n                reject(error);\n              });\n            }\n          });\n        };\n\n        next().then(function () {\n          resolveParent();\n        })[\"catch\"](function (error) {\n          rejectParent(error);\n        });\n      });\n    }\n    /**\r\n     * dispatch\r\n     * @param {Object | Function} - action\r\n     */\n\n  }, {\n    key: \"dispatch\",\n    value: function dispatch(action) {\n      var _this4 = this;\n\n      if (action instanceof Function) {\n        action(this.dispatch.bind(this));\n      } else if (this.middlewares.length) {\n        // 如果有middlewares\n        // before\n        this.runBeforeMiddlewares(action).then(function () {\n          // before的时候去掉action中的success\n          var success = action.success,\n              filterAction = (0, _objectWithoutProperties2[\"default\"])(action, [\"success\"]);\n          trigger.call(_this4, filterAction); // detail\n\n          _this4.state = _this4.reducer(_this4.state, action); // after\n\n          _this4.runAfterMiddlewares(action).then(function () {\n            trigger.call(_this4, action);\n          });\n        });\n      } else {\n        // 如果没有middlewares\n        this.state = this.reducer(this.state, action);\n        trigger.call(this, action);\n      }\n    }\n    /**\r\n     * subscribe\r\n     * @param {Function} - listener\r\n     * @return {Function}\r\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe(listener) {\n      var _this5 = this;\n\n      this.listeners.push(listener);\n      return function () {\n        var index = _this5.listeners.indexOf(listener);\n\n        if (index !== -1) {\n          _this5.listeners.splice(index, 1);\n        }\n      };\n    }\n  }]);\n  return Store;\n}();\n/**\r\n * createStore\r\n * @param {Function} - reducer\r\n * @param {Object | Array} - preloadedState\r\n * @param {Array} - middlewares\r\n * @return {Store}\r\n */\n\n\nvar _default = function _default(reducer, preloadedState, middlewares) {\n  return new Store(reducer, preloadedState, middlewares);\n};\n\nexports[\"default\"] = _default;"],"names":["_interopRequireDefault","require","Object","defineProperty","exports","value","_objectWithoutProperties2","_classCallCheck2","_createClass2","trigger","action","this","listeners","forEach","ins","Store","reducer","_this","preloadedState","arguments","length","undefined","middlewares","state","assign","m","setStore","key","_this2","Promise","resolveParent","rejectParent","index","next","resolve","reject","before","then","error","_this3","after","_this4","Function","dispatch","bind","runBeforeMiddlewares","success","filterAction","call","runAfterMiddlewares","listener","_this5","push","indexOf","splice","_default"],"mappings":"aAEA,IAAIA,uBAAyBC,QAAQ,gDAErCC,OAAOC,eAAeC,QAAS,aAAc,CAC3CC,OAAO,IAETD,QAAiB,aAAI,EAErB,IAAIE,0BAA4BN,uBAAuBC,QAAQ,mDAE3DM,iBAAmBP,uBAAuBC,QAAQ,0CAElDO,cAAgBR,uBAAuBC,QAAQ,uCAMnD,SAASQ,QAAQC,GACCC,KAAKC,UACXC,QAAQ,SAAUC,GAC1BA,EAAIJ,KAUR,IAAIK,MAAqB,WAOvB,SAASA,EAAMC,GACb,IAAIC,EAAQN,KAERO,EAAoC,EAAnBC,UAAUC,aAA+BC,IAAjBF,UAAU,GAAmBA,UAAU,GAAK,GACrFG,EAAiC,EAAnBH,UAAUC,aAA+BC,IAAjBF,UAAU,GAAmBA,UAAU,GAAK,IACtF,EAAIZ,iBAA0B,SAAGI,KAAMI,GAEvCJ,KAAKK,QAAUA,GAAW,SAAUO,GAClC,OAAOA,GAGTZ,KAAKY,MAAQrB,OAAOsB,OAAO,GAAIN,GAC/BP,KAAKW,YAAcA,GAAe,GAElCX,KAAKW,YAAYT,QAAQ,SAAUY,GACjCA,EAAEC,SAAST,KAEbN,KAAKC,UAAY,GAwJnB,OAhJA,EAAIJ,cAAuB,SAAGO,EAAO,CAAC,CACpCY,IAAK,WACLtB,MAAO,WACL,OAAOM,KAAKY,QAQb,CACDI,IAAK,uBACLtB,MAAO,SAA8BK,GACnC,IAAIkB,EAASjB,KAEb,OAAO,IAAIkB,QAAQ,SAAUC,EAAeC,GAC1C,IAAIC,EAAQJ,EAAON,YAAYF,OAAS,GAE7B,SAASa,IAClB,OAAO,IAAIJ,QAAQ,SAAUK,EAASC,GAChCH,EAAQ,EACVE,IAEiBN,EAAON,YAAYU,KACzBI,OAAO,CAChBb,MAAOK,EAAOL,MACdb,OAAQA,IACP2B,KAAK,WAINJ,IAAOI,KAAK,WACVH,QAEM,MAAE,SAAUI,GACpBH,EAAOG,QAMfL,GAAOI,KAAK,WACVP,MACQ,MAAE,SAAUQ,GACpBP,EAAaO,SAUlB,CACDX,IAAK,sBACLtB,MAAO,SAA6BK,GAClC,IAAI6B,EAAS5B,KAEb,OAAO,IAAIkB,QAAQ,SAAUC,EAAeC,GAC1C,IAAIC,EAAQ,GAED,SAASC,IAClB,OAAO,IAAIJ,QAAQ,SAAUK,EAASC,GAChCH,GAASO,EAAOjB,YAAYF,OAC9Bc,IAEiBK,EAAOjB,YAAYU,KACzBQ,MAAM,CACfjB,MAAOgB,EAAOhB,MACdb,OAAQA,IACP2B,KAAK,WACNJ,IAAOI,KAAK,WACVH,QAEM,MAAE,SAAUI,GACpBH,EAAOG,QAMfL,GAAOI,KAAK,WACVP,MACQ,MAAE,SAAUQ,GACpBP,EAAaO,SASlB,CACDX,IAAK,WACLtB,MAAO,SAAkBK,GACvB,IAAI+B,EAAS9B,KAETD,aAAkBgC,SACpBhC,EAAOC,KAAKgC,SAASC,KAAKjC,OACjBA,KAAKW,YAAYF,OAG1BT,KAAKkC,qBAAqBnC,GAAQ2B,KAAK,WAEvB3B,EAAOoC,QAArB,IACIC,GAAe,EAAIzC,0BAAmC,SAAGI,EAAQ,CAAC,YACtED,QAAQuC,KAAKP,EAAQM,GAErBN,EAAOlB,MAAQkB,EAAOzB,QAAQyB,EAAOlB,MAAOb,GAE5C+B,EAAOQ,oBAAoBvC,GAAQ2B,KAAK,WACtC5B,QAAQuC,KAAKP,EAAQ/B,QAKzBC,KAAKY,MAAQZ,KAAKK,QAAQL,KAAKY,MAAOb,GACtCD,QAAQuC,KAAKrC,KAAMD,MAStB,CACDiB,IAAK,YACLtB,MAAO,SAAmB6C,GACxB,IAAIC,EAASxC,KAGb,OADAA,KAAKC,UAAUwC,KAAKF,GACb,WACL,IAAIlB,EAAQmB,EAAOvC,UAAUyC,QAAQH,IAEtB,IAAXlB,GACFmB,EAAOvC,UAAU0C,OAAOtB,EAAO,QAKhCjB,EAhLgB,GA2LrBwC,SAAW,SAAkBvC,EAASE,EAAgBI,GACxD,OAAO,IAAIP,MAAMC,EAASE,EAAgBI,IAG5ClB,QAAiB,QAAImD"}