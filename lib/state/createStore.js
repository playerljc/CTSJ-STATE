"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_immutable=_interopRequireDefault(require("../util/immutable"));function trigger(t){this.listeners.forEach(function(e){e(t)})}var Store=function(){function n(e){var t=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_classCallCheck2.default)(this,n),this.reducer=e||function(e){return e},this.state=Object.assign({},i),this.middlewares=r||[],this.middlewares.forEach(function(e){e.store=t}),this.listeners=[]}return(0,_createClass2.default)(n,[{key:"getState",value:function(){return this.state}},{key:"runBeforeMiddlewares",value:function(s){var a=this;return new Promise(function(e,t){var n=a.middlewares.length-1,u=_immutable.default.cloneDeep(a.state);(function r(){return new Promise(function(t,i){n<0?t():a.middlewares[n--].before({state:u,action:s}).then(function(e){u=e,r().then(function(){t()})}).catch(function(e){i(e)})})})().then(function(){e(u)}).catch(function(e){t(e)})})}},{key:"runAfterMiddlewares",value:function(s){var a=this;return new Promise(function(e,t){var n=0,u=_immutable.default.cloneDeep(a.state);(function r(){return new Promise(function(t,i){n>=a.middlewares.length?t():a.middlewares[n++].after({state:u,action:s}).then(function(e){u=e,r().then(function(){t()})}).catch(function(e){i(e)})})})().then(function(){e(u)}).catch(function(e){t(e)})})}},{key:"dispatch",value:function(i){var r=this;i instanceof Function?i(this.dispatch.bind(this)):this.middlewares.length?this.runBeforeMiddlewares(i).then(function(e){r.state=e;i.success;var t=(0,_objectWithoutProperties2.default)(i,["success"]);trigger.call(r,t),r.state=r.reducer(_immutable.default.cloneDeep(r.state),i),r.runAfterMiddlewares(i).then(function(e){r.state=e,trigger.call(r,i)})}):(this.state=this.reducer(_immutable.default.cloneDeep(this.state),i),trigger.call(this,i))}},{key:"subscribe",value:function(t){var i=this;return this.listeners.push(t),function(){var e=i.listeners.indexOf(t);-1!==e&&i.listeners.splice(e,1)}}}]),n}(),_default=function(e,t,i){return new Store(e,t,i)};exports.default=_default;
//# sourceMappingURL=createStore.js.map
