"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_immutable=_interopRequireDefault(require("../util/immutable"));function trigger(t){this.listeners.forEach(function(e){e(t)})}var Store=function(){function n(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_classCallCheck2.default)(this,n),this.reducer=e||function(e){return e},this.state=Object.assign({},r),this.middlewares=i||[],this.middlewares.forEach(function(e){e.store=t}),this.listeners=[]}return(0,_createClass2.default)(n,[{key:"getState",value:function(){return this.state}},{key:"runBeforeMiddlewares",value:function(u){var a=this;return new Promise(function(e,t){var n=a.middlewares.length-1,s=a.state;(function i(){return new Promise(function(t,r){n<0?t():a.middlewares[n--].before({state:s,action:u}).then(function(e){s=e,i().then(function(){t()})}).catch(function(e){r(e)})})})().then(function(){e(s)}).catch(function(e){t(e)})})}},{key:"runAfterMiddlewares",value:function(u){var a=this;return new Promise(function(e,t){var n=0,s=a.state;(function i(){return new Promise(function(t,r){n>=a.middlewares.length?t():a.middlewares[n++].after({state:s,action:u}).then(function(e){s=e,i().then(function(){t()})}).catch(function(e){r(e)})})})().then(function(){e(s)}).catch(function(e){t(e)})})}},{key:"dispatch",value:function(r){var i=this;r instanceof Function?r(this.dispatch.bind(this)):this.middlewares.length?this.runBeforeMiddlewares(r).then(function(e){i.state=e;r.success;var t=(0,_objectWithoutProperties2.default)(r,["success"]);trigger.call(i,t),i.state=i.reducer(i.state,r),i.runAfterMiddlewares(r).then(function(e){i.state=e,trigger.call(i,r)})}):(this.state=this.reducer(this.state,r),trigger.call(this,r))}},{key:"subscribe",value:function(t){var r=this;return this.listeners.push(t),function(){var e=r.listeners.indexOf(t);-1!==e&&r.listeners.splice(e,1)}}}]),n}(),_default=function(e,t,r){return new Store(e,t,r)};exports.default=_default;
//# sourceMappingURL=createStore.js.map
